{% extends 'base.html' %}
{% block content %}

<style>
.cee-form-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    margin-bottom: 14px;
    border-bottom: none !important;
    box-shadow: none !important;
}
.cee-form-group label {
    font-size: 13px;
    font-weight: 600;
}
.cee-form-group input,
.cee-form-group select {
    height: 36px;
    font-size: 14px;
}

.items-row {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1.2fr 40px;
    gap: 10px;
    align-items: center;
}
.items-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 10px;
    align-items: end;
    margin-bottom: 10px;
}
.cee-form-group {
    position: relative;
}

.suggestion-box {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: #fff;
    border: 1px solid #ccc;
    z-index: 1000;
}

.suggestion-item {
    padding: 6px 10px;
    cursor: pointer;
}

.suggestion-item:hover {
    background: #f1f1f1;
}
@media (max-width: 992px) {
    .cee-form-row {
        grid-template-columns: repeat(3, 1fr);
    }

    .items-row {
        grid-template-columns: 2fr 1fr 1fr;
        row-gap: 8px;
    }

    .items-row button {
        grid-column: span 3;
        justify-self: end;
    }
}
@media (max-width: 576px) {
    .cee-form-row {
        grid-template-columns: 1fr;
    }

    .cee-form-group label {
        font-size: 12px;
    }

    .cee-form-group input,
    .cee-form-group select {
        height: 38px;
        font-size: 14px;
    }

    .items-row {
        grid-template-columns: 1fr;
    }

    .items-row input,
    .items-row select {
        width: 100%;
    }

    .items-row button {
        justify-self: flex-end;
    }
}

</style>

<div class="cee-manage-broker-wrapper">
<div class="cee-broker-form-container">
<div class="cee-manage-broker-wrapper">

    <div class="cee-manage-header">
        <h4>Manage CNote</h4>
    </div>

    <div class="cee-broker-form-container">
        <form method="post">
            {% csrf_token %}
        <div class="cee-form-row">
            <div class="cee-form-group">
                <label>Booking Branch</label>
                {% if user.role == 'ADMIN' %}
                    <select name="booking_branch" required>
                        <option value="">Select an option</option>
                        {% for branch in branches %}
                            <option value="{{ branch.branch_id }}">
                                {{ branch.branch_name }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="text"
                        value="{{ branches.0.branch_name }}"
                        readonly>

                    <input type="hidden"
                        name="booking_branch"
                        value="{{ branches.0.branch_id }}">
                {% endif %}
            </div>
            <div class="cee-form-group">
                <label>Date</label>
                <input type="date" name="date" id="cnote-date">
            </div>

            <div class="cee-form-group">
                <label>Reference No</label>
                <input type="text" name="reference_no">
            </div>

            <div class="cee-form-group">
                <label>Payment</label>
                <select name="payment">
                    <option value="">Select</option>
                    <option value="TOPAY">To Pay</option>
                    <option value="PAID">Paid</option>
                    <option value="CREDIT">Credit</option>
                </select>
            </div>

            

            <div class="cee-form-group">
                <label>LR Charge</label>
                <input type="number" name="lr_charge" value="20">
            </div>
            
            <div class="cee-form-group">
                <label>Invoice No*</label>
                <input type="number" name="invoice_no" required>
            </div>
        </div>

        <div class="cee-form-row">
            <div class="cee-form-group">
                <label>Invoice Amount</label>
                <input type="number" name="invoice_amt" >
            </div>
            <div class="cee-form-group">
                <label>Shipper*</label>
                <input type="text" id="consignor-input">
                <input type="hidden" name="consignor" id="consignor-id">
                <div id="consignor-suggestions" class="suggestion-box"></div>
            </div>

            <div class="cee-form-group">
                <label>Receiver*</label>
                <input type="text" id="consignee-input">
                <input type="hidden" name="consignee" id="consignee-id">
                <div id="consignee-suggestions" class="suggestion-box"></div>
            </div>

            <div class="cee-form-group">
                <label>Location*</label>
                <input type="text" id="location-input">
                <input type="hidden" name="location" id="location-id">
                <div id="location-suggestions" class="suggestion-box"></div>
            </div>
            <div class="cee-form-group">
                <label>Delivery</label>
                <select name="delivery_type">
                    <option value="">Select</option>
                    <option>Door Delivery</option>
                    <option>Godown Delivery</option>
                </select>
            </div>
            <div class="cee-form-group">
                <label>Delivery Branch</label>
                <input type="text" id="branch-input" readonly>
                <input type="hidden" name="branch" id="branch-id">
            </div>
        </div>

        <h6>Items</h6>
        <div id="items-wrapper"></div>

        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItemRow()">+ Add Item</button>
        <button type="button" class="btn btn-outline-primary mb-2"
                            data-bs-toggle="collapse" data-bs-target="#charges-section">
                        Add More Charges
        </button>

        <div class="collapse" id="charges-section">
            <div class="cee-form-row">
                <div class="cee-form-group">
                    <label>Pickup Charge</label>
                    <input type="number" name="pickup_charge" value="0">
                </div>
                <div class="cee-form-group">
                    <label>Hamali Charge</label>
                    <input type="number" name="hamali_charge" value="0">
                </div>
                <div class="cee-form-group">
                    <label>Unloading Charge</label>
                    <input type="number" name="unloading_charge" value="0">
                </div>
                <div class="cee-form-group">
                    <label>Door Delivery</label>
                    <input type="number" name="door_delivery" value="0">
                </div>
                <div class="cee-form-group">
                    <label>Other Charge</label>
                    <input type="number" name="other_charge" value="0">
                </div>
            </div>
        </div>


        <h6 class="mt-3">Summary</h6>
        <div class="cee-form-row">
            <div class="cee-form-group">
                <label>Total Qty</label>
                <input type="number" id="total-items" readonly>
            </div>
            <div class="cee-form-group">
                <label>Freight</label>
                <input type="number" id="freight-total" readonly>
            </div>
            <div class="cee-form-group">
                <label>Grand Total</label>
                <input type="number" id="grand-total" readonly>
            </div>
        </div>

        <button type="submit" class="cee-btn-save mt-3">Save CNote</button>
</form>
</div>
</div>

<script>


const allItems = [
{% for i in items %}
    { item_id: {{ i.item_id }}, item_name: "{{ i.item_name|escapejs }}" },
{% endfor %}
];
console.log(allItems)

const consignors = [{% for c in consignors %}{id:{{c.consignor_id}},name:"{{c.consignor_name|escapejs}}"}, {% endfor %}];
const consignees = [{% for c in consignees %}{id:{{c.consignee_id}},name:"{{c.consignee_name|escapejs}}"}, {% endfor %}];
const locations  = [{% for l in locations %}{id:{{l.location_id}},name:"{{l.location_name|escapejs}}"}, {% endfor %}];

let itemsData = [];
let selectedConsignor = null;
let selectedLocation = null;



function setupAutocomplete(inputId, hiddenId, boxId, data, onSelect) {
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const box = document.getElementById(boxId);

    input.oninput = () => {
        box.innerHTML = "";
        box.style.display = "none";
        if (!input.value) return;

        data.filter(d => d.name.toLowerCase().includes(input.value.toLowerCase()))
            .forEach(d => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                div.textContent = d.name;
                div.onclick = () => {
                    input.value = d.name;
                    hidden.value = d.id;
                    box.style.display = "none";
                    if (onSelect) onSelect(d.id);
                };
                box.appendChild(div);
            });

        if (box.children.length) box.style.display = "block";
    };
}

function loadConsignorItems(consignorId) {
    fetch(`/staff/get-consignor-items/${consignorId}/`)
        .then(r => r.json())
        .then(data => {
            itemsData = data.map(i => ({
                item_id: i.id,
                item_name: i.name,
                rate: i.rate || 0
            }));

            document.getElementById("items-wrapper").innerHTML = "";
            addItemRow();
        });
}


function loadQuotationRates() {
    if (!selectedConsignor || !selectedLocation) return;

    fetch(`/staff/get-quotation-rates/${selectedConsignor}/${selectedLocation}/`)
        .then(r => r.json())
        .then(data => {
            itemsData = allItems.map(i => ({
                item_id: i.item_id,
                item_name: i.item_name,
                rate: 0
            }));

            data.forEach(q => {
                const found = itemsData.find(i => i.item_id === q.item_id);
                if (found) found.rate = q.rate;
            });

            document.getElementById("items-wrapper").innerHTML = "";
            addItemRow();
        });
}

function loadBranchByLocation(locationId) {
    fetch(`/staff/get-branch-by-location/${locationId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.branches.length) {
                document.getElementById("branch-input").value =
                    data.branches[0].branch_name;
                document.getElementById("branch-id").value =
                    data.branches[0].branch_id;
            } else {
                document.getElementById("branch-input").value = "";
                document.getElementById("branch-id").value = "";
            }
        });
}


function addItemRow() {
    const div = document.createElement("div");
    div.className = "items-row";

    div.innerHTML = `
        <select onchange="setRate(this)">
            <option value="">Item</option>
            ${itemsData.map(i =>
                `<option value="${i.item_id}">${i.item_name}</option>`
            ).join("")}
        </select>

        <input type="number" name="qty[]" placeholder="Qty" oninput="calcRow(this)">
        <input type="number" name="rate[]" placeholder="Rate" oninput="calcRow(this)">
        <input type="number" name="total[]" readonly>
        <button type="button" class="btn btn-outline-danger btn-sm">âœ–</button>
    `;

    div.querySelector("button").onclick = () => {
        div.remove();
        updateSummary();
    };

    document.getElementById("items-wrapper").appendChild(div);
}

function setRate(sel) {
    const row = sel.parentElement;
    const item = itemsData.find(i => i.item_id == sel.value);
    row.children[2].value = item ? item.rate : 0;
    calcRow(row.children[2]);
}

function calcRow(el) {
    const row = el.parentElement;
    row.children[3].value =
        ((row.children[1].value || 0) * (row.children[2].value || 0)).toFixed(2);
    updateSummary();
}

function updateSummary() {
    let qty = 0, freight = 0;
    const lrChargeInput = document.querySelector('input[name="lr_charge"]');
    const lrCharge = lrChargeInput ? (+lrChargeInput.value || 0) : 0;
    document.querySelectorAll(".items-row").forEach(r => {
        qty += +r.children[1].value || 0;
        freight += +r.children[3].value || 0;
    });
    const grandTotal = freight + lrCharge;
    document.getElementById("total-items").value = qty;
    document.getElementById("freight-total").value = freight.toFixed(2);
    document.getElementById("grand-total").value = grandTotal.toFixed(2);
}



document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    const dateInput = document.getElementById("cnote-date");

    dateInput.value = today;   
    dateInput.min = today; 

    setupAutocomplete("consignor-input","consignor-id","consignor-suggestions",consignors,
        id => { selectedConsignor = id;loadConsignorItems(id);    if (selectedLocation) loadQuotationRates(); });

    setupAutocomplete("consignee-input","consignee-id","consignee-suggestions",consignees);

    setupAutocomplete("location-input","location-id","location-suggestions",locations,
        id => { selectedLocation = id;loadBranchByLocation(id); if (selectedConsignor) loadQuotationRates(); });
});
</script>

{% endblock %}
