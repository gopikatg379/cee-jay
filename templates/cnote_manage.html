{% extends 'base.html' %}
{% block content %}

<style>
.cee-form-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    margin-bottom: 14px;
    border-bottom: none !important;
    box-shadow: none !important;
}
.cee-form-group label {
    font-size: 13px;
    font-weight: 600;
}
.cee-form-group input,
.cee-form-group select {
    height: 36px;
    font-size: 14px;
}
.cee-form-row:first-of-type {
    margin-bottom: 0;
}
.items-row {
    display: grid;
    grid-template-columns: 3.5fr 1fr 1fr 1.2fr 40px;
    gap: 10px;
    align-items: center;
}
.items-row select,
.items-row input {
    width: 100%;
    min-width: 0; 
}
.items-row select {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.cee-form-group {
    position: relative;
}
.suggestion-box {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: #fff;
    border: 1px solid #ccc;
    z-index: 1000;
}
.suggestion-item {
    padding: 6px 10px;
    cursor: pointer;
}
.suggestion-item:hover {
    background: #f1f1f1;
}
@media (max-width: 992px) {
    .cee-form-row {
        grid-template-columns: repeat(3, 1fr);
    }
    .items-row {
        grid-template-columns: 2fr 1fr 1fr;
        row-gap: 8px;
    }
    .items-row button {
        grid-column: span 3;
        justify-self: end;
    }
}
@media (max-width: 576px) {
    .cee-form-row {
        grid-template-columns: 1fr;
    }
    .cee-form-group label {
        font-size: 12px;
    }
    .cee-form-group input,
    .cee-form-group select {
        height: 38px;
        font-size: 14px;
    }
    .items-row {
        grid-template-columns: 1fr;
    }
    .items-row input,
    .items-row select {
        width: 100%;
    }
    .items-row button {
        justify-self: flex-end;
    }
}
</style>

<div class="cee-manage-broker-wrapper">
<div class="cee-broker-form-container">
<div class="cee-manage-broker-wrapper">

<div class="cee-manage-header d-flex justify-content-between align-items-center">
    <h4>Manage CNote</h4>
    {% if is_edit %}
        <span class="text-white fs-6 fw-bold">
            LR No: <strong>{{ cnote.cnote_number }}</strong>
        </span>
    {% endif %}
</div>

<div class="cee-broker-form-container">
<form method="post">
    {% csrf_token %}
    <div class="cee-form-row">
        <div class="cee-form-group">
            <label>Booking Branch</label>
            {% if user.role == 'ADMIN' %}
            <select name="booking_branch" required>
                <option value="">Select an option</option>
                {% for branch in branches %}
                    <option value="{{ branch.branch_id }}"
                        {% if cnote.booking_branch and cnote.booking_branch.branch_id == branch.branch_id %}
                            selected
                        {% endif %}>
                        {{ branch.branch_name }}
                    </option>
                {% endfor %}
            </select>
            {% else %}
                <input type="text"
                    value="{{ cnote.booking_branch.branch_name }}"
                    readonly>
                <input type="hidden"
                    name="booking_branch"
                    value="{{ cnote.booking_branch.branch_id }}">
            {% endif %}
        </div>
        <div class="cee-form-group">
            <label>Date</label>
            <input type="date" name="date" id="cnote-date">
        </div>
        <div class="cee-form-group">
            <label>Reference No</label>
            <input type="text" name="reference_no" value="{{ cnote.reference_no|default:'' }}">
        </div>
        <div class="cee-form-group">
            <label>Shipper*</label>
            <input type="text" id="consignor-input" value="{{ cnote.consignor.consignor_name|default:'' }}" required>
            <input type="hidden" name="consignor" id="consignor-id" value="{{ cnote.consignor.consignor_id|default:'' }}">
            <div id="consignor-suggestions" class="suggestion-box"></div>
        </div>
        <div class="cee-form-group">
            <label>Payment</label>
            <select name="payment" required>
                <option value="">Select</option>
                {% for p in allowed_payments %}
                    <option value="{{ p }}"
                        {% if cnote.payment == p %}selected{% endif %}>
                        {{ p|title }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="cee-form-group">
            <label>Receiver*</label>
            <input type="text" id="consignee-input" value="{{ cnote.consignee.consignee_name|default:'' }}" required>
            <input type="hidden" name="consignee" id="consignee-id" value="{{ cnote.consignee.consignee_id|default:'' }}">
            <div id="consignee-suggestions" class="suggestion-box"></div>
            <p style="font-size: 10px; color:blue; cursor:pointer;" data-bs-toggle="modal" data-bs-target="#addReceiverModal">
                + Add Receiver
            </p>
        </div>
        
        
    </div>

    <div class="cee-form-row">
        <div class="cee-form-group">
            <label>Receiver Phone</label>
            <input type="text" id="consignee-phone" value="{{ cnote.consignee.consignee_phone|default:'' }}" readonly>
        </div>
        <div class="cee-form-group">
            <label>Location*</label>
            <input type="text" id="location-input" value="{{ cnote.destination.location_name|default:'' }}">
            <input type="hidden" name="location" id="location-id" value="{{ cnote.destination.location_id|default:'' }}">
            <div id="location-suggestions" class="suggestion-box"></div>
        </div>
        <div class="cee-form-group">
            <label>LR Charge</label>
            <input type="number" name="lr_charge" value="{{ cnote.lr_charge|default:'20' }}" oninput="updateSummary()">
        </div>
        <div class="cee-form-group">
            <label>Invoice No*</label>
            <input type="number" name="invoice_no" value="{{ cnote.invoice_no|default:'' }}" required>
        </div>
        <div class="cee-form-group">
            <label>Invoice Amount</label>
            <input type="number" name="invoice_amt" value="{{ cnote.invoice_amt|default:'' }}">
        </div>
        <div class="cee-form-group">
            <label>Eway Number</label>
            <input type="text" name="eway_no" value="{{ cnote.eway_no|default:'' }}">
        </div>
        <div class="cee-form-group">
            <label>Delivery Type</label>
            <select name="delivery_type" required>
                <option>Door Delivery</option>
                <option>Godown Delivery</option>
            </select>
        </div>
        <div class="cee-form-group">
            <label>Delivery Branch</label>
            <input type="text" id="branch-input" value="{{ cnote.delivery_branch.branch_name|default:'' }}" readonly>
            <input type="hidden" name="branch" id="branch-id" value="{{ cnote.delivery_branch.branch_id|default:'' }}">
        </div>
    </div>

    <h6>Items</h6>
    <div id="items-wrapper"></div>

    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItemRow()">+ Add Item</button>
    <button type="button" class="btn btn-outline-primary mb-2"
                        data-bs-toggle="collapse" data-bs-target="#charges-section">
                    Add More Charges
    </button>

    <div class="collapse" id="charges-section">
        <div class="cee-form-row">
            <div class="cee-form-group">
                <label>Pickup Charge</label>
                <input type="number" name="pickup_charge" value="{{ cnote.pickup_charge|default:'0' }}" oninput="updateSummary()">
            </div>
            <div class="cee-form-group">
                <label>Hamali Charge</label>
                <input type="number" name="hamali_charge" value="{{ cnote.hamali_charge|default:'0' }}" oninput="updateSummary()">
            </div>
            <div class="cee-form-group">
                <label>Unloading Charge</label>
                <input type="number" name="unloading_charge" value="{{ cnote.unloading_charge|default:'0' }}" oninput="updateSummary()">
            </div>
            <div class="cee-form-group">
                <label>Door Delivery</label>
                <input type="number" name="door_delivery" value="{{ cnote.door_delivery|default:'0' }}" oninput="updateSummary()">
            </div>
            <div class="cee-form-group">
                <label>Other Charge</label>
                <input type="number" name="other_charge" value="{{ cnote.other_charge|default:'0' }}" oninput="updateSummary()">
            </div>
        </div>
    </div>

    <h6 class="mt-3">Summary</h6>
    <div class="cee-form-row">
        <div class="cee-form-group">
            <label>Total Qty</label>
            <input type="number" id="total-items" readonly>
        </div>
        <div class="cee-form-group">
            <label>Freight</label>
            <input type="number" id="freight-total" readonly>
        </div>
        <div class="cee-form-group">
            <label>Grand Total</label>
            <input type="number" id="grand-total" readonly>
        </div>
        <div class="cee-form-group">
            <label>Remarks</label>
            <input type="text" name="remarks" value="{{ cnote.remarks}}"> 
        </div>
    </div>
    <button type="submit" class="cee-btn-save mt-3">Save CNote</button>
</form>
</div>
</div>

<div class="modal fade" id="addReceiverModal" tabindex="-1" aria-labelledby="addReceiverModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-receiver-form">
        <div class="modal-header">
          <h5 class="modal-title" id="addReceiverModalLabel">Add Receiver</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="receiver-name" class="form-label">Receiver Name</label>
            <input type="text" class="form-control" id="receiver-name" required>
          </div>
          <div class="mb-3">
            <label for="receiver-phone" class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="receiver-phone" value="">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Receiver</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function toggleEwayNumber() {
    const invoiceAmt = +(document.querySelector('input[name="invoice_amt"]').value || 0);
    const ewayField = document.querySelector('input[name="eway_no"]');
    ewayField.readOnly = invoiceAmt < 50000;
    ewayField.style.backgroundColor = invoiceAmt < 50000 ? "#e9ecef" : "#fff";
}

document.querySelector('input[name="invoice_amt"]').addEventListener("input", toggleEwayNumber);

toggleEwayNumber();
const receiverNameInput = document.getElementById("receiver-name");
const receiverPhoneInput = document.getElementById("receiver-phone");

receiverNameInput.addEventListener("input", () => {
    const name = receiverNameInput.value.trim();
    if (!name) {
        receiverPhoneInput.value = "";
        return;
    }
    fetch(`/staff/get-consignee-phone/?name=${encodeURIComponent(name)}`)
        .then(res => res.json())
        .then(data => {
            receiverPhoneInput.value = data.phone || "";
        });
});

document.getElementById("add-receiver-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const name = receiverNameInput.value.trim();
    const phone = receiverPhoneInput.value.trim();
    fetch("{% url 'add_receiver_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ name: name, phone: phone })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            consignees.push({id: data.id, name: data.name, phone: data.phone});
            document.getElementById("consignee-input").value = data.name;
            document.getElementById("consignee-id").value = data.id;
            document.getElementById("consignee-phone").value = data.phone;
            receiverNameInput.value = "";
            receiverPhoneInput.value = "";
            bootstrap.Modal.getInstance(document.getElementById('addReceiverModal')).hide();
        } else {
            alert("Error: " + data.error);
        }
    });
});

const allItems = [
{% for i in items %}
    { item_id: {{ i.item_id }}, item_name: "{{ i.item_name|escapejs }}" },
{% endfor %}
];
const consignors = [
{% for c in consignors %}
{ id: {{ c.consignor_id }}, name: "{{ c.consignor_name|escapejs }}", type: "{{ c.type|upper }}" },
{% endfor %}
];
const consignees = [
{% for c in consignees %}
{ id: {{ c.consignee_id }}, name: "{{ c.consignee_name|escapejs }}", phone: "{{ c.consignee_phone|escapejs }}" },
{% endfor %}
];
const locations = [
{% for l in locations %}
{ id: {{ l.location_id }}, name: "{{ l.location_name|escapejs }}" },
{% endfor %}
];

let itemsData = [];
let selectedConsignor = null;
let selectedLocation = null;

function setupAutocomplete(inputId, hiddenId, boxId, data, onSelect) {
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const box = document.getElementById(boxId);
    input.oninput = () => {
        box.innerHTML = "";
        box.style.display = "none";
        hidden.value = "";
        const value = input.value.trim().toLowerCase();
        if (!value) return;
        const matches = data.filter(d => d.name.toLowerCase().includes(value));
        if (matches.length) {
            matches.forEach(d => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                div.textContent = d.name;
                div.onclick = () => {
                    input.value = d.name;
                    hidden.value = d.id;
                    if (d.phone) document.getElementById("consignee-phone").value = d.phone;
                    box.style.display = "none";
                    if (onSelect) onSelect(d);
                };
                box.appendChild(div);
            });
        } else {
            const noResult = document.createElement("div");
            noResult.className = "suggestion-item text-muted";
            noResult.style.cursor = "default";
            noResult.innerText = "No results found";
            box.appendChild(noResult);

            const addLink = document.createElement("div");
            addLink.className = "suggestion-item text-primary fw-bold";
            addLink.innerHTML = "+ Add Shipper";
            addLink.onclick = () => {
                window.location.href = "{% url 'shipper_add' %}?mode=add";
            };
            box.appendChild(addLink);
        }
        box.style.display = "block";
    };
}
function loadConsignorItems(consignorId) {
    fetch(`/staff/get-consignor-items/${consignorId}/`)
        .then(r => r.json())
        .then(data => {
            itemsData = data.map(i => ({
                item_id: i.id,
                item_name: i.name,
                rate: i.rate || 0
            }));

            document.getElementById("items-wrapper").innerHTML = "";
            addItemRow();
        });
}
function loadQuotationRates() {
    if (!selectedConsignor || !selectedLocation) return;

    fetch(`/staff/get-quotation-rates/${selectedConsignor}/${selectedLocation}/`)
        .then(r => r.json())
        .then(data => {
            if (data.length > 0) {
                itemsData = data.map(i => ({
                    item_id: i.item_id,
                    item_name: i.item_name,
                    rate: i.rate
                }));
            } else if (selectedConsignor) {
                loadConsignorItems(selectedConsignor);
                return; 
            }
            document.getElementById("items-wrapper").innerHTML = "";
            addItemRow();
        });
}

function loadBranchByLocation(locationId) {
    fetch(`/staff/get-branch-by-location/${locationId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.branches.length) {
                document.getElementById("branch-input").value =
                    data.branches[0].branch_name;
                document.getElementById("branch-id").value =
                    data.branches[0].branch_id;
            } else {
                document.getElementById("branch-input").value = "";
                document.getElementById("branch-id").value = "";
            }
        });
}
function addItemRow() {
    const div = document.createElement("div");
    div.className = "items-row";
    div.innerHTML = `
        <select onchange="setRate(this)" name="item[]">
            <option value="">Item</option>
            ${itemsData.map(i => `<option value="${i.item_id}">${i.item_name}</option>`).join("")}
        </select>
        <input type="number" name="qty[]" placeholder="Qty" oninput="calcRow(this)">
        <input type="number" name="rate[]" placeholder="Rate" oninput="calcRow(this)">
        <input type="number" name="total[]" readonly>
        <button type="button" class="btn btn-outline-danger btn-sm">âœ–</button>
    `;
    div.querySelector("button").onclick = () => { div.remove(); updateSummary(); };
    document.getElementById("items-wrapper").appendChild(div);
}

function setRate(sel) {
    const row = sel.parentElement;
    const item = itemsData.find(i => i.item_id == sel.value);
    row.children[2].value = item ? item.rate : 0;
    calcRow(row.children[2]);
}

function calcRow(el) {
    const row = el.parentElement;
    row.children[3].value = ((row.children[1].value || 0) * (row.children[2].value || 0)).toFixed(2);
    updateSummary();
}

function updateSummary() {
    let qty = 0, freight = 0;
    const lrCharge = +(document.querySelector('input[name="lr_charge"]')?.value || 0);
    const pickupCharge = +(document.querySelector('input[name="pickup_charge"]')?.value || 0);
    const hamaliCharge = +(document.querySelector('input[name="hamali_charge"]')?.value || 0);
    const otherCharge = +(document.querySelector('input[name="other_charge"]')?.value || 0);
    const unloadingCharge = +(document.querySelector('input[name="unloading_charge"]')?.value || 0);
    const doorCharge = +(document.querySelector('input[name="door_delivery"]')?.value || 0);
    document.querySelectorAll(".items-row").forEach(r => {
        qty += +r.children[1].value || 0;
        freight += +r.children[3].value || 0;
    });
    const grandTotal = freight + lrCharge + pickupCharge + otherCharge + hamaliCharge + doorCharge + unloadingCharge;
    document.getElementById("total-items").value = qty;
    document.getElementById("freight-total").value = freight.toFixed(2);
    document.getElementById("grand-total").value = grandTotal.toFixed(2);
}

document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("cnote-date").value = today;
    document.getElementById("cnote-date").min = today;

    setupAutocomplete("consignor-input","consignor-id","consignor-suggestions",consignors, consignor => {
        selectedConsignor = consignor.id;
        itemsData = allItems;
        addItemRow();
    });

    setupAutocomplete("consignee-input","consignee-id","consignee-suggestions",consignees, consignee => {
        document.getElementById("consignee-phone").value =  d.phone || "";
    });

    setupAutocomplete("location-input","location-id","location-suggestions",locations,
        location  => { selectedLocation = location.id;loadBranchByLocation(location.id); if (selectedConsignor) loadQuotationRates(); });
});
</script>

{% if is_edit %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    if (!itemsData.length) itemsData = allItems;
    const existingItems = [
    {% for it in cnote.items.all %}
    { item_id: {{ it.item_id }}, qty: {{ it.qty }}, rate: {{ it.rate }}, total: {{ it.total }} },
    {% endfor %}
    ];
    existingItems.forEach(it => {
        addItemRow();
        const rows = document.querySelectorAll(".items-row");
        const row = rows[rows.length - 1];
        setTimeout(() => {
            row.children[0].value = it.item_id;
            row.children[1].value = it.qty;
            row.children[2].value = it.rate;
            row.children[3].value = it.total;
            updateSummary();
        }, 50);
    });
});
</script>
{% endif %}
{% endblock %}
