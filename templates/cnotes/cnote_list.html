{% extends "base.html" %}
{% block content %}
<style>
    .table thead th {
        background-color: #b3b2b2f9; 
        text-align: center;
        vertical-align: middle;
    }
    tr.cancelled-row td{
        color: red;
}
</style>
{% now "Y-m-d" as today %}
<div class="container-fluid">
    <div class="mb-4" style="background-color: #1C4D8D; color: white; padding: 12px 20px; border-radius: 6px; text-align: left; display: flex; align-items: center;">
        <h4>Manage CNote</h4>
    </div>
    <form method="get" class="card p-3 mb-3">
        <h5>Filter</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label>From Date</label>
                <input type="date" name="from_date" class="form-control"
                    value="{{ filters.from_date }}" required style="text-transform: uppercase;">
            </div>

            <div class="col-md-3">
                <label>To Date</label>
                <input type="date" name="to_date" class="form-control"
                    value="{{ filters.to_date|default:today }}">
            </div>

            <div class="col-md-3">
                <label>Status</label>
                <select name="status" class="form-control">
                    <option value="">All</option>
                    {% for key,val in status_choices %}
                        <option value="{{ key }}"
                            {% if filters.status == key %}selected{% endif %}>
                            {{ val }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" >SEARCH</button>
            </div>
        </div>
    </form>


    <div class="d-flex justify-content-between mb-2">
        <a href="{% url 'download_cnote_excel' %}?from_date={{ filters.from_date }}&to_date={{ filters.to_date }}&status={{ filters.status }}&search={{ filters.search }}" class="btn btn-info btn-sm disabled" aria-disabled="true" id="downloadBtn">DOWNLOAD AS EXCEL</a>

        <form method="get" id="searchForm" class="position-relative" style="max-width: 320px;">
                <input type="text"
                    id="searchInput"
                    name="search"
                    placeholder="Search CNote / Invoice No"
                    class="form-control form-control-sm"
                    value="{{ filters.search|default:'' }}"
                    autocomplete="off"
                    autofocus>
            </form>
    </div>

    <div class="card">
    <div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>#</th>
                <th>LR Date</th>
                <th>Booking Branch</th>
                <th>LR No</th>
                <th>Operation Status</th>
                <th>Invoice No</th>
                <th>Shipper</th>
                <th>Receiver</th>
                <th>Destination</th>
                <th>Qty</th>
                <th>Delivery Branch</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for cnote in page_obj %}
            <tr class="{% if cnote.status == 'Cancelled' %}cancelled-row{% endif %}" >
                <td>{{ forloop.counter }}</td>
                <td>{{ cnote.date|date:"d-m-Y" }}</td>
                <td>{{cnote.booking_branch.branch_name}}</td>
                <td>
                    <a href="{% url 'cnote_detail' cnote.pk %}" 
                    class="text-primary fw-bold" 
                    title="View Basic Info">
                        {{ cnote.cnote_number }}
                    </a>
                </td>
                {% if cnote.status == "NEW" %}
                <td>Booked at {{cnote.booking_branch}}</td>
                {% elif cnote.status == "RECEIVED"%}
                <td>Received at {{cnote.received_branch}}</td>
                {% elif cnote.status == "SHIPPED"%}
                <td>Shipped to {{cnote.manifest.branch.branch_name}}</td>
                {% elif cnote.status == "OUT FOR DELIVERY"%}
                <td>Out for delivery</td>
                {% elif cnote.delivery_status == "DELIVERED" %}
                <td>Delivered</td>
                {% elif cnote.is_returned%}
                <td>Return</td>
                {% elif cnote.status == "Cancelled" %}
                <td>Cancelled</td>
                {% endif %}
                <td>{{ cnote.invoice_no|default:"-" }}</td>
                <td>{{ cnote.consignor.consignor_name }}</td>
                <td>{{ cnote.consignee.consignee_name }}</td>
                <td>{{ cnote.destination.location_name }}</td>
                <td>{{ cnote.total_item }}</td>
                <td>{{cnote.delivery_branch.branch_name}}</td>
                <td>
                    <span class="badge 
                        {% if cnote.status == 'NEW' %}bg-secondary
                        {% elif cnote.status == 'RECEIVED' %}bg-primary
                        {% elif cnote.status == 'SHIPPED' %}bg-warning text-dark
                        {% elif cnote.status == 'OUT FOR DELIVERY' %}bg-info text-dark
                        {% elif cnote.status == 'DELIVERED' %}bg-success
                        {% elif cnote.status == 'Cancelled' %}bg-danger
                        {% elif cnote.status == 'RETURN' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ cnote.get_status_display }}
                    </span>
                </td>
                <td>
                {% if cnote.status != "Cancelled" %}
                    <a href="{% url 'cnote_edit' cnote.cnote_id %}" class="btn btn-sm btn-success">
                        <i class="bi bi-pencil"></i>
                    </a>
                    {% if cnote.status == "RECEIVED" and cnote.received_branch == request.user.branch %}
                        <button class="btn btn-sm btn-secondary" disabled title="Already received by your branch">
                            <i class="bi bi-check-circle"></i>
                        </button>
                    {% else %}
                        <a href="{% url 'receive_cnote' cnote.pk %}"
                        class="btn btn-sm btn-warning"
                        title="Receive Consignment">
                            <i class="bi bi-box-arrow-in-down"></i>
                        </a>
                    {% endif %}
                    <button type="button"
                            class="btn btn-sm btn-danger cancel-btn"
                            data-id="{{ cnote.cnote_id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                {% else %}
                    <button class="btn btn-sm btn-secondary" disabled title="Cancelled">
                        <i class="bi bi-trash"></i>
                    </button>
                {% endif %}

                <a href="{% url 'print_cnote' cnote.cnote_id %}" 
                class="btn btn-sm btn-info" 
                target="_blank">
                    <i class="bi bi-printer"></i>
                </a>
                
            </td>
                    
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" class="text-center">No records found</td>
            </tr>
            {% endfor %}
            
        </tbody>
    </table>
    </div>
    </div>

    <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-end">

        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Prev</a>
        </li>
        {% endif %}

        <li class="page-item active">
            <span class="page-link">
                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
            </span>
        </li>

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
        {% endif %}

    </ul>
    </nav>

</div>
<div class="modal fade" id="cancelModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <form method="post" action="{% url 'cnote_cancel' %}">
        {% csrf_token %}

        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Cancel CNote</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="cnote_id" id="cancelCnoteId">

          <div class="mb-3">
            <label class="form-label">Cancellation Remark</label>
            <textarea name="remark"
                      class="form-control"
                      rows="3"
                      required
                      placeholder="Enter reason for cancellation"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button type="submit" class="btn btn-danger">
            Confirm Cancel
          </button>
        </div>

      </form>

    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {

    const searchInput = document.getElementById("searchInput");
    const searchForm = document.getElementById("searchForm");

    searchInput.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {  
            searchForm.submit();
        }
    });

    const selectAllCheckbox = document.querySelector('thead input[type="checkbox"]');
    const rowCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
    const fromDateInput = document.querySelector('input[name="from_date"]');
    const downloadBtn = document.getElementById("downloadBtn");

    if (selectAllCheckbox && rowCheckboxes.length > 0) {

        selectAllCheckbox.addEventListener('change', function () {
            const isChecked = this.checked;
            rowCheckboxes.forEach(cb => cb.checked = isChecked);
        });

        rowCheckboxes.forEach(cb => {
            cb.addEventListener('change', function () {
                const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = !allChecked && someChecked;
            });
        });
    }
    const cancelButtons = document.querySelectorAll(".cancel-btn");
    const cancelInput = document.getElementById("cancelCnoteId");
    const cancelModal = new bootstrap.Modal(document.getElementById("cancelModal"));

    cancelButtons.forEach(btn => {
        btn.addEventListener("click", function () {
            cancelInput.value = this.dataset.id;
            cancelModal.show();
        });
    });
    function toggleDownloadButton() {
        if (fromDateInput.value) {
            downloadBtn.classList.remove("disabled");
            downloadBtn.removeAttribute("aria-disabled");
        } else {
            downloadBtn.classList.add("disabled");
            downloadBtn.setAttribute("aria-disabled", "true");
        }
    }

    toggleDownloadButton();
    fromDateInput.addEventListener("change", toggleDownloadButton);
});
</script>

{% endblock %}
