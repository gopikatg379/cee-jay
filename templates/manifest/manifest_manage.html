{% extends "base.html" %}
{% block content %}
{% now "Y-m-d" as today %}

<style>

#truck {
    position: fixed;
    bottom: 20px;
    left: 20px;
    font-size: 48px;
    cursor: pointer;
    transition: transform 1.2s ease-in-out;
    z-index: 9999;
}

#truckBadge {
    position: absolute;
    top: -8px;
    right: -10px;
    background: red;
    color: white;
    font-size: 14px;
    padding: 2px 7px;
    border-radius: 50%;
    font-weight: bold;
}


.fly-item {
    position: fixed;
    background: #1C4D8D;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 9999;
    transition: all 0.8s ease-in-out;
}

.truck-move {
    transform: translateX(120vw);
}

#loadMessage {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: #198754;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    display: none;
}
</style>
{% if messages %}
  <div class="alert alert-success">
    {% for message in messages %}
      {{ message }}
    {% endfor %}
  </div>
{% endif %}
<div class="container-fluid">

    <div class="mb-4" style="background:#1C4D8D;color:#fff;padding:12px 20px;border-radius:6px;">
        <h4>Manage Manifest</h4>
    </div>
    <form method="POST">
        {% csrf_token %}
    <div class="card mb-3 p-3">
    <div class="row g-3 align-items-end">
        <div class="cee-form-group">
            <label>Booking Branch <span style="color: red;">*</span></label>
            {% if user.role == 'ADMIN' %}
            <select name="booking_branch" required>
                <option value="">Select an option</option>
                {% for branch in branches %}
                    <option value="{{ branch.branch_id }}"
                        {% if cnote.booking_branch and cnote.booking_branch.branch_id == branch.branch_id %}
                            selected
                        {% endif %}>
                        {{ branch.branch_name }}
                    </option>
                {% endfor %}
            </select>
            {% else %}
                <input type="text"
                    value="{{ user.branch.branch_name }}"
                    readonly>
                <input type="hidden"
                    name="booking_branch"
                    value="{{ user.branch.branch_id }}" readonly>
            {% endif %}
        </div>
    <!-- Manifest Type -->
    <div class="col-md-2">
        <label>Manifest Type</label>
        <select name="manifest_type" id="manifestType" class="form-select">
            <option value="">Select</option>
            <option value="DELIVERY">Delivery (DRS)</option>
            <option value="BRANCH">Branch Transfer</option>
        </select>
    </div>

    <!-- Tripping To (Only for Branch) -->
    <div class="col-md-2 d-none" id="hubField">
        <label>Tripping To</label>
        <select name="hub_branch" id="hubSelect" class="form-select">
            <option value="">Select Hub</option>
            {% for hub in branches %}
                <option value="{{ hub.branch_id }}">{{ hub.branch_name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Date -->
    <div class="col-md-2 d-none" id="dateField">
        <label>Date</label>
        <input type="date" name="date" class="form-control" value="{{ today }}">
    </div>

    <!-- Driver -->
    <div class="col-md-2 d-none" id="driverField">
        <label>Driver</label>
        <select name="driver" id="driver" class="form-select">
            <option value="">Select Driver</option>
            {% for d in drivers %}
                <option value="{{ d.driver_id }}">{{ d.driver_name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Vehicle -->
    <div class="col-md-2 d-none" id="vehicleField">
        <label>Vehicle</label>
        <select name="vehicle" id="vehicle" class="form-select">
            <option value="">Select Vehicle</option>
            {% for v in vehicles %}
                <option value="{{ v.vehicle_id }}">{{ v.registration_no }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2 d-none" id="loadedByField">
    <label>Loaded By</label>
    <select name="loaded_by" id="loadedBy" class="form-select">
        <option value="">Select User</option>
        {% for u in branch_users %}
            <option value="{{ u.id }}">{{ u.username }}</option>
        {% endfor %}
    </select>
</div>
        <div class="card mb-3 p-3 d-none" id="modeBox">
        <label class="fw-semibold mb-2">Load Mode</label>
        <div class="d-flex gap-4">
            <div>
                <input type="radio" name="loadMode" id="manualMode" value="manual">
                <label for="manualMode">Manual</label>
            </div>
            <div>
                <input type="radio" name="loadMode" id="qrMode" value="qr">
                <label for="qrMode">QR Scanner</label>
            </div>
        </div>
    </div>
</div>

    </div>



    <!-- QR SCAN INPUT -->
    <div class="card mb-3 p-3 d-none" id="qrSection">
        <label class="fw-semibold">Scan / Enter CNote</label>
        <input type="text" id="qrInput" class="form-control" placeholder="Scan QR or enter CNote number">
    </div>

    <!-- TABLE -->
    <div class="card d-none" id="cnoteTable">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr data-cnote="{{ c.cnote_number }}">
                        <th>#</th>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>LR Date</th>
                        <th>CNote</th>
                        <th>Invoice</th>
                        <th>Consignor</th>
                        <th>Consignee</th>
                        <th>Destination</th>
                        <th>Qty</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                {% for c in page_obj %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><input type="checkbox" class="item-checkbox" name="cnotes[]" value="{{ c.cnote_id }}"></td>
                        <td>{{ c.date|date:"d-m-Y" }}</td>
                        <td>{{ c.cnote_number }}</td>
                        <td>{{ c.invoice_no|default:"-" }}</td>
                        <td>{{ c.consignor.consignor_name }}</td>
                        <td>{{ c.consignee.consignee_name }}</td>
                        <td>{{ c.destination.location_name }}</td>
                        <td>{{ c.total_item }}</td>
                        <td>{{ c.remarks }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="p-3 text-end">
            <button id="saveManifest" type="submit" class="btn btn-success" disabled>
                Save Manifest
            </button>
        </div>
    </div>
    </form>
</div>

<div id="truck">ðŸšš <span id="truckBadge">0</span></div>
<div id="loadMessage">Items loaded successfully!</div>
<script>
document.addEventListener('DOMContentLoaded', function () {

    const manifestType = document.getElementById('manifestType');
    const hubField = document.getElementById('hubField');
    const hubSelect = document.getElementById('hubSelect');

    const dateField = document.getElementById('dateField');
    const driverField = document.getElementById('driverField');
    const vehicleField = document.getElementById('vehicleField');
    const loadedByField = document.getElementById('loadedByField');
    const loadedBy = document.getElementById('loadedBy');
    const driver = document.getElementById('driver');
    const vehicle = document.getElementById('vehicle');

    const modeBox = document.getElementById('modeBox');

function toggleMain() {

    const type = manifestType.value;
    const isBranch = type === "BRANCH";

    hubField.classList.add('d-none');
    dateField.classList.add('d-none');
    driverField.classList.add('d-none');
    vehicleField.classList.add('d-none');
    loadedByField.classList.add('d-none');
    modeBox.classList.add('d-none');

    if (!type) return;


    if (!isBranch) {

        dateField.classList.remove('d-none');
        driverField.classList.remove('d-none');
        vehicleField.classList.remove('d-none');
        loadedByField.classList.remove('d-none');

  
        if (driver.value && vehicle.value) {
            modeBox.classList.remove('d-none');
        }

        return;
    }


    if (isBranch) {

        hubField.classList.remove('d-none');

        if (hubSelect.value) {
            dateField.classList.remove('d-none');
            driverField.classList.remove('d-none');
            vehicleField.classList.remove('d-none');

            if (driver.value && vehicle.value) {
                modeBox.classList.remove('d-none');
            }
        }
    }
}



    manifestType.addEventListener('change', toggleMain);
    hubSelect.addEventListener('change', toggleMain);
    driver.addEventListener('change', toggleMain);
    vehicle.addEventListener('change', toggleMain);
    loadedBy.addEventListener('change', toggleMain);
    const manualMode = document.getElementById('manualMode');
    const qrMode = document.getElementById('qrMode');
    const table = document.getElementById('cnoteTable');
    const qrSection = document.getElementById('qrSection');
    const saveBtn = document.getElementById('saveManifest');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const selectAll = document.getElementById('selectAll');

function toggleLoadMode() {

    table.classList.add('d-none');
    qrSection.classList.add('d-none');

    if (manualMode.checked) {
        table.classList.remove('d-none');
    }

    if (qrMode.checked) {
        qrSection.classList.remove('d-none');
    }

    updateSaveButton();
}


function updateSaveButton() {

    let anyChecked = false;

    checkboxes.forEach(cb => {
        if (cb.checked) anyChecked = true;
    });

    saveBtn.disabled = !anyChecked;
}
selectAll.addEventListener('change', function () {

    document.querySelectorAll('.item-checkbox').forEach(checkbox => {

        checkbox.checked = this.checked;

        const row = checkbox.closest('tr');
        const cnoteNumber = row.children[3].innerText;

        if (this.checked) {
            animateToTruck(row, cnoteNumber);
        } else {
            if (loadedCount > 0) {
                loadedCount--;
                truckBadge.innerText = loadedCount;
            }
        }

    });

    updateSaveButton();
});

checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSaveButton);
});

manualMode.addEventListener('change', toggleLoadMode);
qrMode.addEventListener('change', toggleLoadMode);
const truck = document.getElementById('truck');
const truckBadge = document.getElementById('truckBadge');
const loadMessage = document.getElementById('loadMessage');

let loadedCount = 0;

// =============================
// Animate item to truck
// =============================
function animateToTruck(element, cnoteNumber) {

    const rect = element.getBoundingClientRect();
    const truckRect = truck.getBoundingClientRect();

    const flyItem = document.createElement('div');
    flyItem.className = 'fly-item';
    flyItem.innerText = cnoteNumber;

    document.body.appendChild(flyItem);

    flyItem.style.left = rect.left + 'px';
    flyItem.style.top = rect.top + 'px';

    setTimeout(() => {
        flyItem.style.left = truckRect.left + 'px';
        flyItem.style.top = truckRect.top + 'px';
        flyItem.style.opacity = '0.5';
        flyItem.style.transform = 'scale(0.5)';
    }, 50);

    setTimeout(() => {
        flyItem.remove();
        loadedCount++;
        truckBadge.innerText = loadedCount;
        showLoadMessage();
    }, 900);
}

// =============================
// Show success message
// =============================
function showLoadMessage() {
    loadMessage.style.display = 'block';

    setTimeout(() => {
        loadMessage.style.display = 'none';
    }, 1500);
}

// =============================
// Checkbox change animation
// =============================
document.querySelectorAll('.item-checkbox').forEach(checkbox => {

    checkbox.addEventListener('change', function () {

        if (this.checked) {

            const row = this.closest('tr');
            const cnoteNumber = row.children[3].innerText;

            animateToTruck(row, cnoteNumber);

        } else {

            // If unchecked, reduce count
            if (loadedCount > 0) {
                loadedCount--;
                truckBadge.innerText = loadedCount;
            }
        }

    });

});

});
</script>



{% endblock %}
