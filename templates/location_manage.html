{% extends 'base.html' %}

{% block content %}
<div class="cee-manage-broker-wrapper">
    <div class="cee-manage-header">
        <h4>Manage Location</h4>
        {% if request.GET.mode != 'add' and request.GET.mode != 'edit' %}
            <div id="search-bar" class="cee-search-container d-flex justify-content-center flex-grow-1 mx-4" >
                <form method="get" action="{% url 'location_manage' %}" class="w-100 d-flex justify-content-center">
                    <input type="hidden" name="mode" value="list">
                    <div class="input-group shadow-sm rounded-pill" style="max-width: 480px; background: white;">
                        <span class="input-group-text bg-transparent border-0 ps-4">
                            <i class="bi bi-search text-primary"></i>
                        </span>
                        <input type="text"
                            name="q"
                            class="form-control border-0 shadow-none"
                            placeholder="Search location name, district, shortname..."
                            autocomplete="off">
                    </div>
                </form> 
            </div>
        {% endif %}
        <div class="cee-action-buttons">
            <button class="cee-action-btn {% if request.GET.mode == 'add' %}active{% endif %}" 
                    id="btn-show-form" 
                    title="Add New Location">
                <i class="bi bi-plus-lg"></i>
            </button>
            
            <button class="cee-action-btn {% if not request.GET.mode %}active{% endif %}" 
                    id="btn-show-list" 
                    title="View Location List">
                <i class="bi bi-list-ul"></i>
            </button>
        </div>
    </div>
    <div class="view-container {% if active_tab not in 'add edit' %}d-none{% endif %}" id="view-form">
        <div class="cee-broker-form-container">
            <form method="post">
                {% csrf_token %}
                <div class="cee-form-row">
                    <div class="cee-form-group">
                        <label>PIN Code <span style="color:red;">*</span></label>
                        <input type="text" 
                            id="pincode-input" 
                            name="pincode" 
                            maxlength="6" 
                            pattern="\d{6}" 
                            placeholder="Enter 6-digit PIN" 
                            value="{{location.pincode}}"
                            required>
                        <small class="form-text text-muted">Will auto-fill location & district</small>
                    </div>
                    <div class="cee-form-group position-relative">
                        <label>Location / Post Office <span style="color:red;">*</span></label>
                        <input type="text" 
                            id="location-input" 
                            name="location_name" 
                            placeholder="Type or auto-filled from PIN"
                            value="{{location.location_name}}" 
                            required 
                            autocomplete="off">
                        
                        <div id="location-suggestions" 
                            class="position-absolute w-100 bg-white border shadow-sm"
                            style="max-height: 220px; overflow-y: auto; z-index: 1000; display: none;">
                        </div>
                    </div>

                    <div class="cee-form-group">
                        <label>District <span style="color:red;">*</span></label>
                        <input type="text" 
                            id="district-input" 
                            name="district_name" 
                            placeholder="Auto-filled from PIN" 
                            value="{{location.district}}"
                            readonly
                            required>
                    </div>
                    <div class="cee-form-group">
                        <label>State <span style="color:red;">*</span></label>
                        <input type="text" 
                            id="state-input" 
                            name="state_name" 
                            placeholder="Auto-filled from PIN" 
                            value="{{location.state|default:''}}"
                            required
                            readonly>
                    </div>
                    <div class="cee-form-group">
                        <label>Short Name <span style="color:red;">*</span></label>
                        <input type="text" 
                            id="shortname-input" 
                            name="shortname" 
                            placeholder="Auto-filled from location name"
                            value="{{location.shortname|default:''}}"
                            maxlength="50"
                            required
                            {% if location.shortname %}data-manually-changed="true"{% endif %}>
                        <small class="form-text text-muted">
                            {% if location.shortname %}
                                Currently saved: <strong>{{ location.shortname }}</strong> (edit if needed)
                            {% else %}
                                Will auto-suggest. You can change it.
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div>
                    <label>Select Company & Delivery Branch <span style="color:red;">*</span></label>

                    <div class="company-branch-wrapper">
                        {% for comp in companies %}
                        <div class="company-branch-row">

                            <div class="company-name">
                                {{ comp.comp_name|upper }}
                            </div>
                            <div class="branch-select">
                                <label class="branch-label">Delivery Branch</label>
                                <select name="branches[{{ comp.comp_id }}]" class="form-select">
                                    <option value="">Select Branch</option>

                                    {% for br in branches %}
                                        <option value="{{ br.branch_id }}"
                                            {% if br.branch_id in selected_branch_ids %}selected{% endif %}
                                        >
                                            {{ br.branch_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="rural-field">
                                <label class="branch-label">Rural Commission %</label>
                                <input type="number"
                                    step="0.01"
                                    name="rural_commission_percentage"
                                    class="form-control"
                                    placeholder="0"
                                    value=0>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <small class="text-muted">
                        Select one branch for each company
                    </small>
                </div>


            <button type="submit" class="cee-btn-save">
                {% if is_edit %}Update Location{% else %}Save Location{% endif %}
            </button>
            </form>
        </div>
    </div>
    <div class="view-container {% if request.GET.mode == 'add' %}d-none{% endif %}" id="view-list">
        <div class="p-4">
            <div class="table-wrapper">
            <table class="table table-bordered table-hover">
                <thead class="custom-thead">
                    <tr>
                        <th class="custom-subhead">#</th>
                        <th class="custom-subhead">District</th>
                        <th class="custom-subhead">State</th>
                        <th class="custom-subhead">Location</th>
                        <th class="custom-subhead">Pincode</th>
                        <th class="custom-subhead">Branch</th>
                        <th class="custom-subhead">Location Code</th>
                        {% if user.role == "ADMIN" %}
                        <th class="custom-subhead">Action</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for loc in locations %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ loc.district|upper }}</td>
                        <td>{{ loc.state|upper }}</td>
                        <td>{{ loc.location_name|upper }}</td>
                        <td>{{ loc.pincode|upper }}</td>
                        <td>
                            {% for br in loc.branch.all %}
                                {{ br.branch_name|upper }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td>{{ loc.shortname|upper }}</td>
                        {% if user.role == "ADMIN" %}
                        <td>
                            <a href="{% url 'location_edit' loc.location_id %}" class="btn btn-sm btn-success">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'location_delete' loc.location_id %}" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" class="text-center py-4">No districts found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const pinInput         = document.getElementById('pincode-input');
    const locationInput    = document.getElementById('location-input');
    const districtInput    = document.getElementById('district-input');
    const stateInput       = document.getElementById('state-input');
    const suggestionsBox   = document.getElementById('location-suggestions');
    const shortnameInput   = document.getElementById('shortname-input');

    if (!locationInput || !shortnameInput) {
        console.warn('Required form elements missing');
        return;
    }

    let debounceTimer;
    pinInput.addEventListener('input', function () {
        const pin = this.value.trim();

        if (pin.length !== 6) {
            locationInput.value = '';
            districtInput.value = '';
            suggestionsBox.style.display = 'none';
            return;
        }

        if (/^\d{6}$/.test(pin)) {
            fetchLocationFromPin(pin);
        }
    });

    async function fetchLocationFromPin(pin) {
        try {
            const response = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
            const data = await response.json();

            if (data[0]?.Status === "Success" && data[0]?.PostOffice?.length > 0) {
                const offices = data[0].PostOffice;
                const mainOffice = offices[0];

                locationInput.value = mainOffice.Name || '';
                districtInput.value = mainOffice.District || '';
                stateInput.value    = mainOffice.State || '';

                if (offices.length > 1) {
                    showLocationSuggestions(offices);
                } else {
                    suggestionsBox.style.display = 'none';
                }

                updateShortNameSuggestion();
            } else {
                locationInput.value = '';
                districtInput.value = '';
                stateInput.value    = '';
                suggestionsBox.style.display = 'none';
                alert('PIN Code not found or invalid');
            }
        } catch (err) {
            console.error('PIN lookup error:', err);
            alert('Error connecting to location service');
        }
    }

    locationInput.addEventListener('input', function () {
        clearTimeout(debounceTimer);

        const query = this.value.trim();

        if (query.length < 3) {
            suggestionsBox.style.display = 'none';
            return;
        }

        debounceTimer = setTimeout(() => {
            searchLocation(query);
        }, 400);
    });

    async function searchLocation(query) {
        try {
            const response = await fetch(`https://api.postalpincode.in/postoffice/${query}`);
            const data = await response.json();

            if (data[0]?.Status === "Success" && data[0]?.PostOffice?.length > 0) {
                showLocationSuggestions(data[0].PostOffice);
            } else {
                suggestionsBox.innerHTML = '<div class="p-2 text-muted">No matching locations found</div>';
                suggestionsBox.style.display = 'block';
            }
        } catch (err) {
            console.error('Location search error:', err);
            suggestionsBox.innerHTML = '<div class="p-2 text-danger">Error searching locations</div>';
            suggestionsBox.style.display = 'block';
        }
    }

    function showLocationSuggestions(offices) {
        suggestionsBox.innerHTML = '';

        offices.forEach(office => {
            const item = document.createElement('div');
            item.className = 'p-2 border-bottom hover-bg-light cursor-pointer';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <strong>${office.Name}</strong><br>
                <small>${office.District}, ${office.State} - ${office.Pincode}</small>
            `;

            item.addEventListener('click', () => {
                locationInput.value = office.Name;
                districtInput.value = office.District;
                stateInput.value    = office.State;
                pinInput.value = office.Pincode;
                suggestionsBox.style.display = 'none';

                updateShortNameSuggestion();
            });

            suggestionsBox.appendChild(item);
        });

        suggestionsBox.style.display = 'block';
    }

    function updateShortNameSuggestion() {
        if (shortnameInput.dataset.manuallyChanged === 'true' && 
            shortnameInput.value.trim() !== '') {
            return;
        }

        const name = (locationInput.value || '').trim().toUpperCase();
        if (!name) {
            shortnameInput.value = '';
            return;
        }

        let clean = name.replace('(PO)','').replace('PO','').replace('-',' ').trim();
        const words = clean.split(/\s+/).filter(Boolean);

        let code = '';

        if (words.length === 0) {
            code = '';
        } else if (words.length === 1) {
            code = words[0].slice(0,3);
        } else {
            code = words[0][0] + words[words.length - 1].slice(0,2);
        }

        const overrides = {
            'KOCHI': 'KCH',
            'ERNAKULAM': 'EKM',
            'FORTKOCHI': 'FTK',
            'FORT KOCHI': 'FTK',
            'MARADU': 'MRD',
            'KAKKANAD': 'KKD',
            'VYTTILA': 'VYT',
            'THOPPUMPADY': 'TPY',
        };

        for (const [k, v] of Object.entries(overrides)) {
            if (clean.includes(k)) {
                code = v;
                break;
            }
        }

        shortnameInput.value = code.slice(0,3);
    }

    locationInput.addEventListener('input', updateShortNameSuggestion);
    locationInput.addEventListener('change', updateShortNameSuggestion);

    shortnameInput.addEventListener('input', function() {
        this.dataset.manuallyChanged = 'true';
    });

    document.addEventListener('click', function(e) {
        if (!locationInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
            suggestionsBox.style.display = 'none';
        }

        if (e.target.closest('#location-suggestions')) {
            shortnameInput.dataset.manuallyChanged = '';
            setTimeout(updateShortNameSuggestion, 100);
        }
    });

    updateShortNameSuggestion();

    const btnForm  = document.getElementById('btn-show-form');
    const btnList  = document.getElementById('btn-show-list');
    const viewForm = document.getElementById('view-form');
    const viewList = document.getElementById('view-list');

    if (btnForm && btnList) {
        btnForm.addEventListener('click', () => {
            viewForm.classList.remove('d-none');
            viewList.classList.add('d-none');
            btnForm.classList.add('active');
            btnList.classList.remove('active');
            history.pushState({}, '', '?mode=add');
        });

        btnList.addEventListener('click', () => {
            viewList.classList.remove('d-none');
            viewForm.classList.add('d-none');
            btnList.classList.add('active');
            btnForm.classList.remove('active');
            history.pushState({}, '', location.pathname);
        });
    }
});
</script>
<style>
    .hover-bg-light:hover {
        background-color: #f8f9fa;
    }
    #location-suggestions div {
        transition: background-color 0.1s;
    }
<style>
    .hover-bg-light:hover {
        background-color: #f8f9fa;
    }
    #location-suggestions div {
        transition: background-color 0.1s;
    }
.company-branch-wrapper {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.company-branch-row {
    display: flex;
    align-items: center;      /* important change */
    gap: 30px;
}

.company-name {
    width: 220px;
    font-weight: 600;
    text-transform: uppercase;
    display: flex;
    align-items: center;
}

.branch-select,
.rural-field {
    display: flex;
    flex-direction: column;
}

.branch-select {
    width: 300px;
}

.rural-field {
    width: 180px;
}

.branch-label {
    font-size: 13px;
    margin-bottom: 6px;
}

.branch-select select,
.rural-field input {
    height: 38px;              /* force same height */
}


</style>


</style>

{% endblock %}