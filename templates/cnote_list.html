{% extends "base.html" %}
{% block content %}
{% now "Y-m-d" as today %}
<div class="container-fluid">

<form method="get" class="card p-3 mb-3">
    <h5>Filter</h5>
    <div class="row g-3">
        <div class="col-md-3">
            <label>From Date</label>
            <input type="date" name="from_date" class="form-control"
                   value="{{ filters.from_date }}">
        </div>

        <div class="col-md-3">
            <label>To Date</label>
            <input type="date" name="to_date" class="form-control"
                   value="{{ filters.to_date|default:today }}">
        </div>

        <div class="col-md-3">
            <label>Status</label>
            <select name="status" class="form-control">
                <option value="">All</option>
                {% for key,val in status_choices %}
                    <option value="{{ key }}"
                        {% if filters.status == key %}selected{% endif %}>
                        {{ val }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success w-100">SEARCH</button>
        </div>
    </div>
</form>


<div class="d-flex justify-content-between mb-2">
    <a href="{% url 'download_cnote_excel' %}?from_date={{ filters.from_date }}&to_date={{ filters.to_date }}&status={{ filters.status }}&search={{ filters.search }}" class="btn btn-info btn-sm">DOWNLOAD AS EXCEL</a>

    <form method="get" id="searchForm">
    <input type="text"
           id="searchInput"
           name="search"
           placeholder="Search CNote / Invoice"
           class="form-control form-control-sm"
           value="{{ filters.search }}"
           autocomplete="off">
</form>
</div>

<div class="card">
<div class="table-responsive">
<table class="table table-bordered table-hover">
    <thead>
        <tr>
            <th>#</th>
            <th><input type="checkbox"></th>
            <th>LR Date</th>
            <th>CNote No</th>
            <th>Operation Status</th>
            <th>Invoice No</th>
            <th>Consignor</th>
            <th>Consignee</th>
            <th>Destination</th>
            <th>Qty</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for cnote in page_obj %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td><input type="checkbox"></td>
            <td>{{ cnote.date|date:"d-m-Y" }}</td>
            <td>{{ cnote.cnote_id }}</td>
            {% if cnote.status == "NEW" %}
            <td>Booked</td>
            {% elif cnote.status == "DISPATCHED"%}
            <td>In Transit</td>
            {% elif cnote.status == "DELIVERED" %}
            <td>Delivered</td>
            {% endif %}
            <td>{{ cnote.invoice_no|default:"-" }}</td>
            <td>{{ cnote.consignor.consignor_name }}</td>
            <td>{{ cnote.consignee.consignee_name }}</td>
            <td>{{ cnote.destination.location_name }}</td>
            <td>{{ cnote.total_item }}</td>
            <td>
                <span class="badge bg-secondary">
                    {{ cnote.get_status_display }}
                </span>
            </td>
            <td>
                <a href="#" class="btn btn-sm btn-success">
                    <i class="bi bi-pencil"></i>
                </a>
                <a href="#" class="btn btn-sm btn-danger">
                    <i class="bi bi-trash"></i>
                </a>
                <a href="{% url 'print_cnote' cnote.cnote_id %}" 
                class="btn btn-sm btn-info" 
                target="_blank"
                title="Print Consignment Note">
                    <i class="bi bi-printer"></i>
                </a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="11" class="text-center">No records found</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
</div>

<nav class="mt-3">
<ul class="pagination pagination-sm justify-content-end">

    {% if page_obj.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Prev</a>
    </li>
    {% endif %}

    <li class="page-item active">
        <span class="page-link">
            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
    </li>
    {% endif %}

</ul>
</nav>

</div>
<script>
let searchTimer = null;

document.getElementById("searchInput").addEventListener("keyup", function () {
    clearTimeout(searchTimer);

    searchTimer = setTimeout(() => {
        document.getElementById("searchForm").submit();
    }, 400);
});

document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.querySelector('thead input[type="checkbox"]');
    const rowCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');

    if (!selectAllCheckbox || rowCheckboxes.length === 0) return;

    selectAllCheckbox.addEventListener('change', function () {
        const isChecked = this.checked;

        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });

    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);

            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = !allChecked && someChecked;
        });
    });
});
</script>
{% endblock %}
